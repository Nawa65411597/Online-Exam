<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå üéì (Online Exam System)</title>
    
    <!-- 1. ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Sarabun', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- 3. React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Lucide Icons (Latest Version) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 5. Firebase (Compat Mode) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #error-log {
            display: none; position: fixed; bottom: 20px; right: 20px; max-width: 400px;
            background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 8px;
            border: 1px solid #f87171; font-family: monospace; font-size: 12px; z-index: 9999;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="flex flex-col items-center justify-center min-h-screen text-gray-500">
            <!-- Loading fallback without icon library -->
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mb-4"></div>
            <p class="text-lg font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö... ‚è≥</p>
        </div>
    </div>
    <div id="error-log"></div>

    <script type="text/babel">
        // --- 0. Global Error Handler ---
        window.onerror = function(msg, source, lineno, colno, error) {
            const el = document.getElementById('error-log');
            if(el) { el.style.display = 'block'; el.innerHTML = `<strong>System Error ‚ùå:</strong><br/>${msg}<br/>Line: ${lineno}`; }
            console.error("App Error:", error);
        };

        const { useState, useEffect, useRef, useMemo } = React;

        // --- 1. Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA7VSQL0LNIBEsMqKeJikS-xvKv4OBA3hQ",
            authDomain: "online-exam-e0282.firebaseapp.com",
            projectId: "online-exam-e0282",
            storageBucket: "online-exam-e0282.firebasestorage.app",
            messagingSenderId: "743597814646",
            appId: "1:743597814646:web:7daff8ce1f01623df8c057",
            measurementId: "G-75674HXF78"
        };

        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } 
        catch (e) { console.error("Firebase Init Error", e); }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'online-exam-default'; 
        // Collections
        const COL_Q = `artifacts/${appId}/public/data/questions`;
        const COL_R = `artifacts/${appId}/public/data/results`;
        const COL_S = `artifacts/${appId}/public/data/settings`;
        const DOC_S = 'config';

        // --- 2. Icon Component (Robust Fix for Case Sensitivity) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            
            useEffect(() => {
                if (!window.lucide) return;

                // 1. Try PascalCase (e.g., CheckCircle)
                let iconDef = window.lucide.icons[name];
                
                // 2. If not found, try camelCase (e.g., checkCircle)
                if (!iconDef) {
                    const camelName = name.charAt(0).toLowerCase() + name.slice(1);
                    iconDef = window.lucide.icons[camelName];
                }

                // 3. If still not found, try UpperCase (some builds)
                if (!iconDef && window.lucide.icons[name.toUpperCase()]) {
                     iconDef = window.lucide.icons[name.toUpperCase()];
                }

                if (ref.current && iconDef) {
                    ref.current.innerHTML = '';
                    
                    if (typeof window.lucide.createElement === 'function') {
                        // New API
                        const svg = window.lucide.createElement(iconDef);
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        const cls = svg.getAttribute('class') || '';
                        svg.setAttribute('class', (cls + ' ' + className).trim());
                        ref.current.appendChild(svg);
                    } else if (typeof iconDef.toSvg === 'function') {
                        // Old API
                        ref.current.innerHTML = iconDef.toSvg({ class: className, width: size, height: size });
                    }
                } else if (!iconDef) {
                    console.warn(`Icon not found: ${name}`);
                    // Fallback text if icon missing
                    if(ref.current) ref.current.innerText = '';
                }
            }, [name, size, className]);

            return <span ref={ref} className={`inline-flex items-center justify-center align-middle ${className}`} style={{ width: size, height: size }}></span>;
        };

        // --- 3. Utilities ---
        const shuffle = (arr) => [...arr].sort(() => Math.random() - 0.5);
        const formatTime = (s) => {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        };

        const exportToCSV = (data, filename) => {
            if (!data || !data.length) return;
            const headers = ['Timestamp', 'Student ID', 'Name', 'Score', 'Total', 'Passed', 'Cheating Warnings'];
            const rows = data.map(item => {
                const dateStr = item.timestamp?.seconds 
                ? new Date(item.timestamp.seconds * 1000).toLocaleString() 
                : item.timestamp || '';
                return [`"${dateStr}"`, `"${item.studentId}"`, `"${item.firstName} ${item.lastName}"`, item.score, item.total, item.passed ? "Yes" : "No", item.warnings || 0];
            });
            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const downloadTemplate = () => {
            const headers = ['Question (‡πÇ‡∏à‡∏ó‡∏¢‡πå)', 'Option A', 'Option B', 'Option C', 'Option D', 'Correct Answer (‡πÄ‡∏â‡∏•‡∏¢‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1-4)'];
            const sampleRows = [['"1 + 1 ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?"', '1', '2', '3', '4', '2'], ['"‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏∑‡∏≠?"', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø', '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '3']];
            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(",") + "\n" + sampleRows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "exam_template.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- 4. Sub-Components ---
        const Modal = ({ isOpen, onClose, title, children, size='md' }) => {
            if (!isOpen) return null;
            const maxW = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-3xl', xl: 'max-w-5xl' }[size];
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className={`bg-white rounded-2xl shadow-2xl w-full ${maxW} overflow-hidden animate-slide-up flex flex-col max-h-[90vh]`} onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-4 border-b bg-gray-50">
                            <h3 className="font-bold text-lg text-gray-800">{title}</h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-200 text-gray-500 transition"><Icon name="X" size={24}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">{children}</div>
                    </div>
                </div>
            );
        };

        const RichTextEditor = ({ value, onChange, placeholder }) => {
            return (
                <div className="border rounded-lg overflow-hidden focus-within:ring-2 ring-indigo-500 transition">
                    <div className="bg-gray-50 p-2 border-b flex gap-1">
                        <span className="text-xs text-gray-400 self-center mr-2">HTML Editor:</span>
                        <button className="p-1 hover:bg-gray-200 rounded" onClick={()=>onChange(value + '<b></b>')} title="Bold"><Icon name="Bold" size={16}/></button>
                        <button className="p-1 hover:bg-gray-200 rounded" onClick={()=>onChange(value + '<i></i>')} title="Italic"><Icon name="Italic" size={16}/></button>
                        <div className="w-px h-4 bg-gray-300 mx-1 self-center"></div>
                        <button className="p-1 hover:bg-gray-200 rounded" onClick={()=>{const url=prompt("Image URL:"); if(url) onChange(value + `<img src="${url}" class="max-w-full h-auto my-2 rounded"/>`)}} title="Image"><Icon name="Image" size={16}/></button>
                    </div>
                    <textarea className="w-full p-3 h-32 text-sm font-mono outline-none resize-y" value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder || "‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HTML Tags..."}></textarea>
                </div>
            );
        };

        const StatusBar = ({ currentStep, totalQuestions, answers }) => {
            if (currentStep === 'quiz') {
                const answeredCount = answers.filter(a => a !== null).length;
                const percentage = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;
                return (
                    <div className="w-full max-w-4xl mx-auto mb-6 px-4">
                        <div className="flex justify-between items-end mb-2">
                            <div><span className="text-sm font-bold text-indigo-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö üöÄ</span><div className="text-xs text-gray-500">‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß {answeredCount} ‡∏à‡∏≤‡∏Å {totalQuestions} ‡∏Ç‡πâ‡∏≠</div></div>
                            <span className="text-xl font-black text-indigo-600">{percentage}%</span>
                        </div>
                        <div className="h-4 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner relative">
                            <div className="absolute w-full h-full flex">{Array.from({length: totalQuestions}).map((_, i) => (<div key={i} className={`flex-1 border-r border-white/20 ${answers[i] ? 'bg-green-500' : 'bg-gray-300'}`}></div>))}</div>
                            <div className="h-full bg-green-500 transition-all duration-500 ease-out opacity-50" style={{ width: `${percentage}%` }}></div>
                        </div>
                    </div>
                );
            }
            const steps = [{ id: 'landing', label: '‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠', icon: 'User' }, { id: 'instruction', label: '‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á', icon: 'FileText' }, { id: 'quiz', label: '‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö', icon: 'PenTool' }, { id: 'result', label: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö', icon: 'CheckCircle' }];
            const stepIdx = steps.findIndex(s => s.id === currentStep);
            if (stepIdx === -1) return null;
            return (
                <div className="w-full max-w-3xl mx-auto mb-8 px-4">
                    <div className="flex justify-between items-center relative">
                        <div className="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-gray-200 -z-10"></div>
                        <div className="absolute left-0 top-1/2 transform -translate-y-1/2 h-1 bg-green-500 -z-10 transition-all duration-500" style={{ width: `${(stepIdx / (steps.length - 1)) * 100}%` }}></div>
                        {steps.map((s, i) => {
                            const isActive = i <= stepIdx;
                            const isCurrent = i === stepIdx;
                            return (
                                <div key={i} className="flex flex-col items-center gap-2 bg-f3f4f6 px-2">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all duration-300 bg-white ${isActive ? 'border-green-500 text-green-600' : 'border-gray-300 text-gray-400'} ${isCurrent ? 'ring-4 ring-green-100 scale-110' : ''}`}><Icon name={s.icon} size={18} /></div>
                                    <span className={`text-xs font-bold ${isActive ? 'text-green-700' : 'text-gray-400'}`}>{s.label}</span>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- 5. Main Logic ---
        const ExamApp = () => {
            const [view, setView] = useState('landing');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [modal, setModal] = useState(null);
            
            // Dashboard States
            const [activeTab, setActiveTab] = useState('questions');
            const [searchTerm, setSearchTerm] = useState('');
            
            // Data
            const [questions, setQuestions] = useState([]);
            const [results, setResults] = useState([]);
            const [settings, setSettings] = useState({ 
                randomCount: 5, totalTime: 60, 
                shuffleQuestions: true, 
                shuffleOptions: true,
                instructions: `<ul class="list-disc pl-5"><li>‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢</li><li>‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</li></ul>` 
            });

            // Computed Data
            const filteredResults = useMemo(() => {
                if(!searchTerm) return results;
                const lower = searchTerm.toLowerCase();
                return results.filter(r => 
                    (r.studentId || '').toLowerCase().includes(lower) || 
                    (r.firstName || '').toLowerCase().includes(lower) ||
                    (r.lastName || '').toLowerCase().includes(lower)
                );
            }, [results, searchTerm]);

            // Exam Session
            const [student, setStudent] = useState({ name: '', id: '' });
            const [activeQs, setActiveQs] = useState([]);
            const [answers, setAnswers] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            const [timer, setTimer] = useState(0);
            const [warnings, setWarnings] = useState(0);
            const [isSubmitting, setIsSubmitting] = useState(false);

            // Teacher
            const [importing, setImporting] = useState(false);

            // Init
            useEffect(() => {
                auth.signInAnonymously().catch(e => alert("Auth Error: " + e.message));
                auth.onAuthStateChanged(u => { setUser(u); setLoading(false); });
            }, []);

            // Realtime Data
            useEffect(() => {
                if(!user) return;
                const unsubQ = db.collection(COL_Q).orderBy('timestamp', 'asc').onSnapshot(s => setQuestions(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubR = db.collection(COL_R).orderBy('timestamp', 'desc').onSnapshot(s => setResults(s.docs.map(d => ({id: d.id, ...d.data()}))));
                db.collection(COL_S).doc(DOC_S).get().then(d => { if(d.exists) setSettings(prev => ({...prev, ...d.data()})); });
                return () => { unsubQ(); unsubR(); };
            }, [user]);

            // Sync Settings Limit
            useEffect(() => {
                if(questions.length > 0 && settings.randomCount > questions.length) {
                    setSettings(p => ({...p, randomCount: questions.length}));
                }
            }, [questions.length]);

            // Timer & Anti-Cheat
            useEffect(() => {
                let interval;
                if(view === 'quiz' && timer > 0 && !isSubmitting) {
                    interval = setInterval(() => {
                        setTimer(t => {
                            if(t <= 1) { clearInterval(interval); handleSubmitExam(answers, warnings, true); return 0; }
                            return t - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [view, timer, isSubmitting, answers, warnings]);

            useEffect(() => {
                if(view !== 'quiz' || isSubmitting) return;
                const handleBlur = () => {
                    setWarnings(w => {
                        const nw = w + 1;
                        if(nw >= 3) { alert("‚ö†Ô∏è ‡∏ú‡∏¥‡∏î‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ"); handleSubmitExam(answers, nw, true); }
                        else alert(`üö® ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${nw}/3: ‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏≠‡∏ö!`);
                        return nw;
                    });
                };
                window.addEventListener('blur', handleBlur);
                return () => window.removeEventListener('blur', handleBlur);
            }, [view, isSubmitting, answers]);

            // Actions
            const handleStartExam = () => {
                if(questions.length === 0) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‚ùå");
                
                // 1. Prepare Questions
                let examQs = [...questions];
                
                // 2. Shuffle Questions if enabled
                if(settings.shuffleQuestions) {
                    examQs = shuffle(examQs);
                }
                
                // 3. Slice by randomCount
                examQs = examQs.slice(0, settings.randomCount);

                // 4. Shuffle Options if enabled
                if(settings.shuffleOptions) {
                    examQs = examQs.map(q => {
                        const optsWithStatus = q.options.map((opt, i) => ({ text: opt, isCorrect: i === q.correct }));
                        const shuffledOpts = shuffle(optsWithStatus);
                        return {
                            ...q,
                            options: shuffledOpts.map(o => o.text),
                            correct: shuffledOpts.findIndex(o => o.isCorrect)
                        };
                    });
                }

                setActiveQs(examQs);
                setAnswers(Array(examQs.length).fill(null));
                setTimer(settings.totalTime * 60);
                setWarnings(0);
                setQIndex(0);
                setView('quiz');
            };

            const handleAnswer = (optIdx) => {
                const newAns = [...answers];
                newAns[qIndex] = { qId: activeQs[qIndex].id, opt: optIdx, correct: optIdx === activeQs[qIndex].correct };
                setAnswers(newAns);
            };

            const handleSubmitExam = async (finalAnswers, finalWarnings, force=false) => {
                if(!force && !window.confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? üì§")) return;
                setIsSubmitting(true);
                try {
                    const score = finalAnswers.reduce((acc, a) => acc + (a && a.correct ? 1 : 0), 0);
                    const safeName = student.name || "Unknown";
                    const resultData = {
                        studentId: student.id || "N/A",
                        firstName: safeName.split(' ')[0] || safeName,
                        lastName: safeName.split(' ')[1] || '',
                        score: score,
                        total: activeQs.length,
                        passed: activeQs.length > 0 ? (score / activeQs.length) >= 0.6 : false,
                        warnings: finalWarnings,
                        timestamp: new Date() 
                    };
                    await db.collection(COL_R).add(resultData);
                    setView('result');
                } catch (e) {
                    console.error("Submit Error:", e);
                    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö: " + e.message);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleSaveQuestion = (q) => {
                const data = { 
                    question: q.question, options: q.options, correct: Number(q.correct), 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                };
                const ref = q.id ? db.collection(COL_Q).doc(q.id) : db.collection(COL_Q).doc(String(Date.now()));
                ref.set(data, { merge: true }).then(() => setModal(null));
            };

            const handleDeleteQuestion = (id) => {
                if(confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ? üóëÔ∏è")) db.collection(COL_Q).doc(id).delete();
            };

            const handleImportCSV = (file) => {
                setImporting(true);
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const rows = e.target.result.split(/\r\n|\n|\r/).filter(r => r.trim());
                        const batch = db.batch();
                        let count = 0;
                        for(let i=1; i<rows.length; i++) {
                            const cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
                            if(cols.length >= 6) {
                                const qText = cols[0];
                                const opts = [cols[1], cols[2], cols[3], cols[4]];
                                const match = cols[5].match(/\d+/);
                                let corr = -1;
                                if(match) corr = parseInt(match[0]) - 1; 
                                if(corr >= 0 && corr < 4 && qText) {
                                    const id = String(Date.now() + i);
                                    batch.set(db.collection(COL_Q).doc(id), { question: qText, options: opts, correct: corr, timestamp: firebase.firestore.FieldValue.serverTimestamp(), id: id });
                                    count++;
                                }
                            }
                        }
                        if(count > 0) batch.commit().then(() => alert(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${count} ‡∏Ç‡πâ‡∏≠`));
                        else alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                    } catch(err) { console.error(err); alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
                    setImporting(false);
                };
                reader.readAsText(file);
            };

            if(loading) return <div className="flex h-screen items-center justify-center"><Icon name="Loader" className="animate-spin mr-2"/> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... ‚è≥</div>;

            if(view === 'landing') return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-4 animate-fade-in">
                    <StatusBar currentStep="landing" />
                    <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-4xl text-center">
                        <div className="inline-block p-4 bg-blue-100 rounded-full mb-6"><Icon name="BookOpen" size={48} className="text-blue-600"/></div>
                        <h1 className="text-4xl font-extrabold text-gray-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå üéì</h1>
                        <p className="text-gray-500 mb-10">Online Examination System</p>
                        <div className="grid md:grid-cols-2 gap-6">
                            <button onClick={() => setModal({ type: 'student-login' })} className="p-8 border-2 border-transparent hover:border-blue-500 bg-gray-50 rounded-2xl flex flex-col items-center hover:shadow-lg transition group"><div className="bg-white p-4 rounded-full shadow-sm mb-4 group-hover:scale-110 transition"><Icon name="User" size={32} className="text-blue-600"/></div><h3 className="text-xl font-bold text-gray-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö (‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô) üë®‚Äçüéì</h3></button>
                            <button onClick={() => setModal({ type: 'teacher-login' })} className="p-8 border-2 border-transparent hover:border-indigo-500 bg-gray-50 rounded-2xl flex flex-col items-center hover:shadow-lg transition group"><div className="bg-white p-4 rounded-full shadow-sm mb-4 group-hover:scale-110 transition"><Icon name="Lock" size={32} className="text-indigo-600"/></div><h3 className="text-xl font-bold text-gray-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö (‡∏Ñ‡∏£‡∏π) üë©‚Äçüè´</h3></button>
                        </div>
                    </div>
                    <Modal isOpen={modal?.type === 'student-login'} onClose={()=>setModal(null)} title="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö üîê" size="sm"><div className="space-y-4"><input className="w-full p-3 border rounded-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" value={student.id} onChange={e=>setStudent({...student, id:e.target.value})}/><input className="w-full p-3 border rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" value={student.name} onChange={e=>setStudent({...student, name:e.target.value})}/><button onClick={()=>{ if(student.id && student.name) setView('instruction'); else alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‚ùå"); }} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö üöÄ</button></div></Modal>
                    <Modal isOpen={modal?.type === 'teacher-login'} onClose={()=>setModal(null)} title="Teacher Login üîê" size="sm"><div className="space-y-4"><input type="password" id="pwd" className="w-full p-3 border rounded-lg" placeholder="Password"/><button onClick={()=>{ if(document.getElementById('pwd').value === 'Nu65411597') setView('teacher'); else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‚ùå"); }} className="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚úÖ</button></div></Modal>
                </div>
            );

            if(view === 'instruction') return (
                <div className="flex flex-col min-h-screen p-4 animate-fade-in">
                    <StatusBar currentStep="instruction" />
                    <div className="max-w-3xl mx-auto w-full bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div className="text-center pt-8 pb-4 px-6"><h2 className="text-2xl font-bold text-gray-800">‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö üìù</h2><div className="mt-2 text-indigo-600 font-medium bg-indigo-50 inline-block px-4 py-1 rounded-full">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö: {student.name} ({student.id})</div></div>
                        <div className="px-8 py-4"><div className="bg-white rounded-xl border-2 border-gray-100 p-6 text-gray-700 prose prose-sm max-w-none" dangerouslySetInnerHTML={{__html: settings.instructions}}></div></div>
                        <div className="flex flex-wrap justify-center gap-4 bg-blue-50 mx-8 mb-6 p-4 rounded-lg border border-blue-100 text-sm text-blue-800 font-bold">
                            <div className="flex items-center gap-2"><Icon name="Clock"/> ‡πÄ‡∏ß‡∏•‡∏≤: {settings.totalTime} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                            <div className="flex items-center gap-2"><Icon name="FileText"/> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: {settings.randomCount} ‡∏Ç‡πâ‡∏≠</div>
                            {settings.shuffleQuestions && <div className="flex items-center gap-2 bg-blue-100 px-2 py-1 rounded text-blue-900"><Icon name="Shuffle" size={14}/> ‡∏™‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠</div>}
                            {settings.shuffleOptions && <div className="flex items-center gap-2 bg-blue-100 px-2 py-1 rounded text-blue-900"><Icon name="Shuffle" size={14}/> ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>}
                        </div>
                        <div className="flex gap-4 px-8 pb-8"><button onClick={handleStartExam} className="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‚úçÔ∏è</button><button onClick={()=>{setView('landing'); setModal(null);}} className="px-6 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold hover:bg-gray-300 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‚ùå</button></div>
                    </div>
                </div>
            );

            if(view === 'quiz') {
                const q = activeQs[qIndex];
                return (
                    <div className="flex flex-col min-h-screen p-4 animate-fade-in">
                        <StatusBar currentStep="quiz" totalQuestions={activeQs.length} answers={answers} />
                        <div className="max-w-4xl mx-auto w-full">
                            <div className="bg-white rounded-2xl shadow-sm p-4 mb-6 flex justify-between items-center sticky top-2 z-10 border border-gray-100">
                                <div className="flex items-center gap-3"><div className="bg-indigo-100 p-2 rounded-full text-indigo-600 font-bold text-sm">‡∏Ç‡πâ‡∏≠ {qIndex + 1}</div><div className="text-sm hidden sm:block text-gray-500">‡∏à‡∏≤‡∏Å {activeQs.length}</div></div>
                                <div className={`flex items-center gap-2 px-4 py-2 rounded-full font-mono font-bold text-lg ${timer < 300 ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-gray-100 text-gray-700'}`}><Icon name="Clock" size={20}/> {formatTime(timer)} ‚è±Ô∏è</div>
                                <button onClick={()=>handleSubmitExam(answers, warnings)} disabled={isSubmitting} className={`px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 ${isSubmitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'}`}>{isSubmitting ? <><Icon name="Loader" className="animate-spin"/> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á... ‚è≥</> : "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö üì§"}</button>
                            </div>
                            <div className="bg-white rounded-2xl shadow-lg p-8 mb-6 min-h-[200px]"><div className="mb-2 text-gray-400 text-sm font-bold">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà {qIndex + 1} ‚ùì</div><div className="text-xl text-gray-800 leading-relaxed font-medium" dangerouslySetInnerHTML={{__html: q.question}}></div></div>
                            <div className="grid gap-3">{q.options.map((opt, idx) => { const isSelected = answers[qIndex]?.opt === idx; return (<button key={idx} onClick={() => handleAnswer(idx)} className={`p-4 rounded-xl border-2 text-left transition flex items-center gap-4 group ${isSelected ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50'}`}><div className={`w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold text-sm ${isSelected ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-300 group-hover:border-blue-400'}`}>{['A','B','C','D'][idx]}</div><div className="text-lg text-gray-700">{opt}</div></button>); })}</div>
                            <div className="flex justify-between mt-8 pb-10"><button disabled={qIndex === 0} onClick={() => setQIndex(i => i - 1)} className="px-6 py-3 bg-white border border-gray-300 rounded-xl font-bold text-gray-600 hover:bg-gray-50 disabled:opacity-50">‚¨ÖÔ∏è ‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button><button disabled={qIndex === activeQs.length - 1} onClick={() => setQIndex(i => i + 1)} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 disabled:opacity-50">‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button></div>
                        </div>
                    </div>
                );
            }

            if(view === 'result') return (
                <div className="flex flex-col min-h-screen p-4 animate-fade-in"><StatusBar currentStep="result" /><div className="flex-grow flex items-center justify-center"><div className="bg-white p-12 rounded-3xl shadow-2xl text-center max-w-lg w-full"><div className="inline-block p-6 bg-green-100 rounded-full mb-6 animate-bounce"><Icon name="Award" size={64} className="text-green-600"/></div><h2 className="text-3xl font-bold text-gray-800 mb-2">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! üéâ</h2><p className="text-gray-500 mb-8">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß</p><button onClick={()=>{setView('landing'); setModal(null);}} className="w-full bg-gray-900 text-white py-4 rounded-xl font-bold hover:bg-black transition transform hover:scale-105">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å üè†</button></div></div></div>
            );

            if(view === 'teacher') return (
                <div className="max-w-6xl mx-auto my-6 bg-white min-h-[90vh] rounded-2xl shadow-xl flex flex-col animate-fade-in overflow-hidden">
                    <div className="bg-slate-800 text-white p-6 flex justify-between items-center sticky top-0 z-20"><div className="flex items-center gap-3"><div className="bg-white/10 p-2 rounded-lg"><Icon name="Settings" size={24}/></div><div><h2 className="font-bold text-xl">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö üõ†Ô∏è</h2><p className="text-xs text-slate-400">Admin Panel</p></div></div><div className="flex gap-3"><button onClick={() => { const headers = ['Timestamp,Student ID,Name,Score,Total,Passed,Warnings']; const csv = headers.concat(results.map(r => `"${r.timestamp?.seconds ? new Date(r.timestamp.seconds*1000).toLocaleString() : ''}","${r.studentId}","${r.firstName} ${r.lastName}",${r.score},${r.total},${r.passed?'Pass':'Fail'},${r.warnings||0}` )).join('\n'); const link = document.createElement('a'); link.href = 'data:text/csv;charset=utf-8,%EF%BB%BF' + encodeURI(csv); link.download = 'exam_results.csv'; link.click(); }} className="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg font-bold text-sm flex gap-2 items-center"><Icon name="Download" size={16}/> Export ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô üì•</button><button onClick={()=>setView('landing')} className="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-bold text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö üö™</button></div></div>
                    <div className="p-6 overflow-y-auto flex-grow bg-slate-50">
                        <div className="flex border-b border-gray-200 mb-6 gap-4"><button onClick={()=>setActiveTab('questions')} className={`pb-2 font-bold transition ${activeTab==='questions'?'text-indigo-600 border-b-2 border-indigo-600':'text-gray-500 hover:text-gray-700'}`}>‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö üóÇÔ∏è</button><button onClick={()=>setActiveTab('results')} className={`pb-2 font-bold transition ${activeTab==='results'?'text-indigo-600 border-b-2 border-indigo-600':'text-gray-500 hover:text-gray-700'}`}>‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö üìä</button><button onClick={()=>setActiveTab('settings')} className={`pb-2 font-bold transition ${activeTab==='settings'?'text-indigo-600 border-b-2 border-indigo-600':'text-gray-500 hover:text-gray-700'}`}>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ‚öôÔ∏è</button></div>
                        {activeTab === 'settings' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div className="bg-white p-6 rounded-xl shadow-sm border">
                                <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Icon name="Clock" size={18}/> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between"><span>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö (‡∏ô‡∏≤‡∏ó‡∏µ):</span><input type="number" className="border p-2 rounded w-20 text-center font-bold" value={settings.totalTime} onChange={e=>setSettings({...settings, totalTime: Number(e.target.value)})}/></div>
                                    <div className="flex items-center justify-between"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°:</span><input type="number" className="border p-2 rounded w-20 text-center font-bold" value={settings.randomCount} onChange={e=>setSettings({...settings, randomCount: Number(e.target.value)})}/></div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border">
                                <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Icon name="Shuffle" size={18}/> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏° (Shuffle)</h3>
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border"><span>‡∏™‡∏•‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå (Shuffle Questions)</span><input type="checkbox" className="w-6 h-6 accent-indigo-600" checked={settings.shuffleQuestions !== false} onChange={e=>setSettings({...settings, shuffleQuestions: e.target.checked})}/></div>
                                    <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border"><span>‡∏™‡∏•‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Shuffle Options)</span><input type="checkbox" className="w-6 h-6 accent-indigo-600" checked={settings.shuffleOptions !== false} onChange={e=>setSettings({...settings, shuffleOptions: e.target.checked})}/></div>
                                </div>
                            </div>
                            <div className="md:col-span-2 flex justify-end gap-2"><button onClick={()=>setModal({type:'instruction-edit'})} className="py-2 px-6 border border-indigo-600 text-indigo-600 rounded-lg font-bold hover:bg-indigo-50 transition">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á üìù</button><button onClick={()=>db.collection(COL_S).doc(DOC_S).set(settings).then(()=>alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ"))} className="py-2 px-8 bg-blue-600 text-white rounded-lg font-bold shadow-lg hover:bg-blue-700 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ üíæ</button></div>
                        </div>
                        )}
                        {activeTab === 'questions' && (
                        <div><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-xl text-gray-800">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö üóÇÔ∏è ({questions.length})</h3><div className="flex gap-2"><button onClick={()=>document.getElementById('csvInput').click()} className="bg-white border border-blue-600 text-blue-600 px-3 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-blue-50">{importing ? <Icon name="Loader" className="animate-spin" size={16}/> : <Icon name="Upload" size={16}/>} Import CSV</button><input id="csvInput" type="file" accept=".csv" className="hidden" onChange={e=>handleImportCSV(e.target.files[0])} disabled={importing}/><button onClick={()=>setModal({type:'question-form', data:{}})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-700 flex items-center gap-2"><Icon name="PlusCircle" size={18}/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button></div></div><div className="space-y-4">{questions.map((q, i) => (<div key={q.id} className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition flex gap-4"><div className="bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center font-bold text-gray-500 shrink-0">{i+1}</div><div className="flex-grow"><div className="font-medium text-lg text-gray-800 mb-2" dangerouslySetInnerHTML={{__html: q.question}}></div><div className="grid grid-cols-2 gap-x-8 gap-y-2 text-sm text-gray-600">{q.options.map((o, idx) => (<div key={idx} className={`flex items-center gap-2 ${idx===q.correct ? 'text-green-600 font-bold':''}`}><div className={`w-2 h-2 rounded-full ${idx===q.correct ? 'bg-green-500':'bg-gray-300'}`}></div> {o}</div>))}</div></div><div className="flex flex-col gap-2 border-l pl-4 justify-center"><button onClick={()=>setModal({type:'question-form', data:q})} className="text-gray-400 hover:text-indigo-600 p-2 hover:bg-indigo-50 rounded"><Icon name="Edit" size={18}/></button><button onClick={()=>handleDeleteQuestion(q.id)} className="text-gray-400 hover:text-red-600 p-2 hover:bg-red-50 rounded"><Icon name="Trash2" size={18}/></button></div></div>))}</div></div>
                        )}
                        {activeTab === 'results' && (
                        <div><div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"><div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100"><p className="text-gray-500 text-sm">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î üë•</p><p className="text-3xl font-bold text-indigo-600">{results.length}</p></div><div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100"><p className="text-gray-500 text-sm">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ üìà</p><p className="text-3xl font-bold text-green-600">{results.length > 0 ? (results.reduce((a,b)=>a+b.score,0)/results.length).toFixed(1) : 0}</p></div><div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100"><p className="text-gray-500 text-sm">‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‚úÖ</p><p className="text-3xl font-bold text-emerald-600">{results.filter(r=>r.passed).length}</p></div><div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100"><p className="text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‚ùå</p><p className="text-3xl font-bold text-red-500">{results.filter(r=>!r.passed).length}</p></div></div><div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6"><div className="flex gap-4 items-center"><Icon name="User" className="text-gray-400"/><input placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô... üîç" className="flex-grow outline-none bg-transparent" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/></div></div><div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-left border-collapse min-w-[800px]"><thead><tr className="bg-gray-50 text-gray-600 text-sm font-bold border-b"><th className="p-4">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á üïí</th><th className="p-4">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô üÜî</th><th className="p-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• üë§</th><th className="p-4 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô üìä</th><th className="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ üèÅ</th><th className="p-4 text-center">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‚ö†Ô∏è</th></tr></thead><tbody className="divide-y divide-gray-100">{filteredResults.map((r, i) => (<tr key={i} className="hover:bg-blue-50/50 transition"><td className="p-4 text-sm text-gray-500">{r.timestamp?.seconds ? new Date(r.timestamp.seconds*1000).toLocaleString('th-TH') : '-'}</td><td className="p-4 font-mono text-indigo-600 font-bold">{r.studentId}</td><td className="p-4 font-medium">{r.firstName} {r.lastName}</td><td className="p-4 text-center"><span className="text-lg font-bold text-gray-800">{r.score}</span><span className="text-gray-400 text-sm">/{r.total}</span></td><td className="p-4 text-center"><span className={`px-3 py-1 rounded-full text-xs font-bold ${r.passed ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{r.passed ? '‡∏ú‡πà‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}</span></td><td className="p-4 text-center">{r.warnings > 0 ? <span className="inline-flex items-center gap-1 text-red-600 bg-red-50 px-2 py-1 rounded text-xs font-bold border border-red-100"><Icon name="AlertTriangle" size={12}/> {r.warnings} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span> : <span className="text-gray-300">-</span>}</td></tr>))}</tbody></table></div></div></div>
                        )}
                    </div>
                    <Modal isOpen={modal?.type === 'question-form'} onClose={()=>setModal(null)} title={modal?.data?.id ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‚úèÔ∏è" : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‚ûï"} size="lg"><QuestionForm initialData={modal.data} onSave={handleSaveQuestion} onCancel={()=>setModal(null)}/></Modal>
                    <Modal isOpen={modal?.type === 'instruction-edit'} onClose={()=>setModal(null)} title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á üìù" size="lg"><div className="space-y-4"><RichTextEditor value={settings.instructions} onChange={v=>setSettings({...settings, instructions: v})} /><div className="flex justify-end gap-2 pt-4"><button onClick={()=>setModal(null)} className="px-4 py-2 bg-gray-200 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‚ùå</button><button onClick={()=>{db.collection(COL_S).doc(DOC_S).set(settings).then(()=>alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ")); setModal(null);}} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å üíæ</button></div></div></Modal>
                </div>
            );
            return null;
        };

        const QuestionForm = ({ initialData, onSave, onCancel }) => {
            const [q, setQ] = useState(initialData?.question || '');
            const [opts, setOpts] = useState(initialData?.options || ['','','','']);
            const [correct, setCorrect] = useState(initialData?.correct !== undefined ? initialData.correct : 0);
            const handleOptChange = (i, val) => { const newOpts = [...opts]; newOpts[i] = val; setOpts(newOpts); };
            return (<div className="space-y-6"><div><label className="font-bold block mb-2 text-gray-700">‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚ùì</label><RichTextEditor value={q} onChange={setQ} placeholder="‡πÉ‡∏™‡πà‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." /></div><div><label className="font-bold block mb-2 text-gray-700">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å) üî°</label><div className="space-y-3">{opts.map((opt, i) => (<div key={i} className={`flex items-center gap-3 p-3 rounded-lg border transition cursor-pointer ${correct===i ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-gray-300'}`} onClick={()=>setCorrect(i)}><div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${correct===i ? 'border-green-600 bg-green-600 text-white' : 'border-gray-300 bg-white'}`}>{correct===i && <Icon name="CheckCircle" size={14}/>}</div><input className="flex-grow bg-transparent outline-none border-b border-transparent focus:border-indigo-400 py-1" value={opt} onChange={e=>handleOptChange(i, e.target.value)} placeholder={`‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${i+1}`} onClick={e=>e.stopPropagation()}/></div>))}</div></div><div className="pt-4 border-t flex justify-end gap-3"><button onClick={onCancel} className="px-6 py-2.5 bg-gray-100 hover:bg-gray-200 rounded-lg font-bold text-gray-600 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‚ùå</button><button onClick={()=>onSave({ id: initialData?.id, question: q, options: opts, correct })} className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-bold text-white shadow-md transition flex items-center gap-2"><Icon name="Save" size={18}/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å üíæ</button></div></div>);
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExamApp />);
    </script>
</body>
</html>
