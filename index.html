<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Secure Exam System)</title>
    
    <!-- 1. ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.4s ease-out' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- 3. React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Lucide Icons (Fixed Version) -->
    <script src="https://unpkg.com/lucide@0.344.0"></script>
    
    <!-- 5. Firebase (Compat Mode) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #error-log { display: none; position: fixed; bottom: 20px; right: 20px; max-width: 400px; background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 8px; border: 1px solid #f87171; font-family: monospace; font-size: 12px; z-index: 9999; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* --- Security Styles --- */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .watermark-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 9999; /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå */
            pointer-events: none; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏õ‡∏∏‡πà‡∏° */
            display: flex;
            flex-wrap: wrap;
            justify-content: center; /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á */
            align-content: center;
            overflow: hidden;
            background: transparent;
        }

        .watermark-item {
            transform: rotate(-25deg);
            color: #374151; 
            opacity: 0.30; 
            font-size: 40px; 
            font-weight: 900;
            white-space: nowrap;
            margin: 80px; 
            user-select: none;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5); 
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="flex flex-col items-center justify-center min-h-screen text-gray-500">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mb-4"></div>
            <p class="text-lg font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö... ‚è≥</p>
        </div>
    </div>
    <div id="error-log"></div>

    <script type="text/babel">
        // --- 0. Global Error Handler ---
        window.onerror = function(msg, source, lineno, colno, error) {
            const el = document.getElementById('error-log');
            if(el) { el.style.display = 'block'; el.innerHTML = `<strong>System Error ‚ùå:</strong><br/>${msg}<br/>Line: ${lineno}`; }
            console.error("App Error:", error);
        };

        const { useState, useEffect, useRef, useMemo } = React;

        // --- 1. Firebase Config ---
        // ‡πÉ‡∏ä‡πâ Config ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Environment ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyA7VSQL0LNIBEsMqKeJikS-xvKv4OBA3hQ",
            authDomain: "online-exam-e0282.firebaseapp.com",
            projectId: "online-exam-e0282",
            storageBucket: "online-exam-e0282.firebasestorage.app",
            messagingSenderId: "743597814646",
            appId: "1:743597814646:web:7daff8ce1f01623df8c057",
            measurementId: "G-75674HXF78"
        };

        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } 
        catch (e) { console.error("Firebase Init Error", e); }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        // ‡πÉ‡∏ä‡πâ App ID ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ Fallback
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'online-exam-default'; 
        
        // Use proper paths for this environment
        const COL_Q = `artifacts/${appId}/public/data/questions`;
        const COL_R = `artifacts/${appId}/public/data/results`;
        const COL_S = `artifacts/${appId}/public/data/settings`;
        const DOC_S = 'config';

        // --- 2. Components ---

        // 2.1 Icon
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!window.lucide) return;
                let iconDef = window.lucide.icons[name] || window.lucide.icons[name.charAt(0).toLowerCase() + name.slice(1)];
                if (ref.current && iconDef) {
                    ref.current.innerHTML = '';
                    const svg = window.lucide.createElement(iconDef);
                    svg.setAttribute('width', size); svg.setAttribute('height', size);
                    svg.setAttribute('class', (svg.getAttribute('class') || '') + ' ' + className);
                    ref.current.appendChild(svg);
                }
            }, [name, size, className]);
            return <span ref={ref} className={`inline-flex items-center justify-center align-middle ${className}`} style={{ width: size, height: size }}></span>;
        };

        // 2.2 Watermark (Updated: Remove IP, Keep Name/ID)
        const WatermarkOverlay = ({ text }) => {
            const items = Array.from({ length: 30 }).map((_, i) => (
                <div key={i} className="watermark-item">
                    {text} {/* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ (‡∏£‡∏´‡∏±‡∏™ - ‡∏ä‡∏∑‡πà‡∏≠) ‡πÑ‡∏°‡πà‡∏°‡∏µ IP ‡πÅ‡∏•‡πâ‡∏ß */}
                </div>
            ));
            return <div className="watermark-overlay">{items}</div>;
        };

        // 2.3 Utilities
        const shuffle = (arr) => [...arr].sort(() => Math.random() - 0.5);
        const formatTime = (s) => { const m = Math.floor(s / 60); const sec = s % 60; return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`; };

        // 2.4 Modal & Editor
        const Modal = ({ isOpen, onClose, title, children, size='md' }) => {
            if (!isOpen) return null;
            const maxW = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-3xl', xl: 'max-w-5xl' }[size];
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className={`bg-white rounded-2xl shadow-2xl w-full ${maxW} overflow-hidden animate-slide-up flex flex-col max-h-[90vh]`} onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-4 border-b bg-gray-50">
                            <h3 className="font-bold text-lg text-gray-800">{title}</h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-200 text-gray-500 transition"><Icon name="X" size={24}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">{children}</div>
                    </div>
                </div>
            );
        };

        const RichTextEditor = ({ value, onChange, placeholder }) => (
            <div className="border rounded-lg overflow-hidden focus-within:ring-2 ring-indigo-500 transition">
                <div className="bg-gray-50 p-2 border-b flex gap-1">
                    <span className="text-xs text-gray-400 self-center mr-2">HTML:</span>
                    <button className="p-1 hover:bg-gray-200 rounded" onClick={()=>onChange(value + '<b></b>')}><Icon name="Bold" size={16}/></button>
                    <button className="p-1 hover:bg-gray-200 rounded" onClick={()=>{const url=prompt("Image URL:"); if(url) onChange(value + `<img src="${url}" class="max-w-full h-auto my-2 rounded"/>`)}}><Icon name="Image" size={16}/></button>
                </div>
                <textarea className="w-full p-3 h-32 text-sm font-mono outline-none resize-y" value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder || "‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HTML Tags..."}></textarea>
            </div>
        );

        const StatusBar = ({ currentStep, totalQuestions, answers }) => {
            if (currentStep === 'quiz') {
                const answeredCount = answers.filter(a => a !== null).length;
                const percentage = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;
                return (
                    <div className="w-full max-w-4xl mx-auto mb-6 px-4 z-10 relative">
                        <div className="flex justify-between items-end mb-2">
                            <div><span className="text-sm font-bold text-indigo-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ üöÄ</span><div className="text-xs text-gray-500">‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß {answeredCount} ‡∏à‡∏≤‡∏Å {totalQuestions} ‡∏Ç‡πâ‡∏≠</div></div>
                            <span className="text-xl font-black text-indigo-600">{percentage}%</span>
                        </div>
                        <div className="h-3 w-full bg-gray-200 rounded-full overflow-hidden shadow-inner relative">
                            <div className="h-full bg-green-500 transition-all duration-500 ease-out" style={{ width: `${percentage}%` }}></div>
                        </div>
                    </div>
                );
            }
            const steps = [{ id: 'landing', label: '‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠', icon: 'User' }, { id: 'instruction', label: '‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á', icon: 'FileText' }, { id: 'quiz', label: '‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö', icon: 'PenTool' }, { id: 'result', label: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö', icon: 'CheckCircle' }];
            const stepIdx = steps.findIndex(s => s.id === currentStep);
            if (stepIdx === -1) return null;
            return (
                <div className="w-full max-w-3xl mx-auto mb-8 px-4 z-10 relative">
                    <div className="flex justify-between items-center relative">
                        <div className="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-gray-200 -z-10"></div>
                        <div className="absolute left-0 top-1/2 transform -translate-y-1/2 h-1 bg-green-500 -z-10 transition-all duration-500" style={{ width: `${(stepIdx / (steps.length - 1)) * 100}%` }}></div>
                        {steps.map((s, i) => {
                            const isActive = i <= stepIdx;
                            return (
                                <div key={i} className="flex flex-col items-center gap-2 bg-f3f4f6 px-2">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all bg-white ${isActive ? 'border-green-500 text-green-600' : 'border-gray-300 text-gray-400'} ${i === stepIdx ? 'ring-4 ring-green-100 scale-110' : ''}`}><Icon name={s.icon} size={18} /></div>
                                    <span className={`text-xs font-bold ${isActive ? 'text-green-700' : 'text-gray-400'}`}>{s.label}</span>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- 3. Main Logic ---
        const ExamApp = () => {
            const [view, setView] = useState('landing');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [modal, setModal] = useState(null);
            const [refreshKey, setRefreshKey] = useState(0); 

            // Data & Config
            const [questions, setQuestions] = useState([]);
            const [results, setResults] = useState([]);
            const [settings, setSettings] = useState({ randomCount: 5, totalTime: 60, shuffleQuestions: true, shuffleOptions: true, instructions: `<ul><li>‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢</li></ul>` });

            // Session
            const [student, setStudent] = useState({ name: '', id: '' });
            const [activeQs, setActiveQs] = useState([]);
            const [answers, setAnswers] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            const [timer, setTimer] = useState(0);
            const [warnings, setWarnings] = useState(0);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [activeTab, setActiveTab] = useState('questions');
            const [importing, setImporting] = useState(false);

            const STORAGE_KEY = `exam_checkpoint_${appId}`;

            // 3.1 Init & Auth (FIXED: Ensure auth triggers)
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                initAuth();

                const unsubAuth = auth.onAuthStateChanged(u => { 
                    setUser(u); 
                    if(u) setLoading(false); 
                });
                return () => unsubAuth();
            }, []);

            // 3.1.5 Restore Session from LocalStorage
            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const s = JSON.parse(saved);
                        // Validate basic structure
                        if (s.view === 'quiz' && s.student && s.activeQs) {
                            setStudent(s.student);
                            setActiveQs(s.activeQs);
                            setAnswers(s.answers);
                            setQIndex(s.qIndex);
                            setTimer(s.timer);
                            setWarnings(s.warnings);
                            setView('quiz');
                            console.log("Restored session");
                        }
                    } catch(e) { console.error("Restore failed", e); localStorage.removeItem(STORAGE_KEY); }
                }
            }, []);

            // 3.1.6 Auto-Save Session
            useEffect(() => {
                if (view === 'quiz' && !isSubmitting) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        view: 'quiz', student, activeQs, answers, qIndex, timer, warnings
                    }));
                }
            }, [view, student, activeQs, answers, qIndex, timer, warnings, isSubmitting]);

            // 3.2 Fetch Data (Optimized)
            useEffect(() => {
                if(!user) return;
                const unsubQ = db.collection(COL_Q).orderBy('timestamp', 'asc')
                    .onSnapshot(s => setQuestions(s.docs.map(d => ({id: d.id, ...d.data()}))));
                db.collection(COL_S).doc(DOC_S).get().then(d => { if(d.exists) setSettings(prev => ({...prev, ...d.data()})); });
                return () => unsubQ();
            }, [user]);

            useEffect(() => {
                if(view === 'teacher' && activeTab === 'results') {
                    setLoading(true);
                    db.collection(COL_R).orderBy('timestamp', 'desc').limit(100).get()
                    .then(s => {
                        setResults(s.docs.map(d => ({id: d.id, ...d.data()})));
                        setLoading(false);
                    });
                }
            }, [view, refreshKey, activeTab]);

            // 3.3 Security Logic
            useEffect(() => {
                if (view !== 'quiz') return;

                const handleContextMenu = (e) => { e.preventDefault(); return false; };
                const handleKeyDown = (e) => {
                    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) { e.preventDefault(); alert('‚ö†Ô∏è Developer Tools Blocked'); }
                    if (e.ctrlKey && (e.key === 'c' || e.key === 'C')) { e.preventDefault(); alert('‚ö†Ô∏è Copying Blocked'); }
                    if (e.ctrlKey && (e.key === 'p' || e.key === 'P')) { e.preventDefault(); alert('‚ö†Ô∏è Printing Blocked'); }
                };
                const handleKeyUp = (e) => {
                    if (e.key === 'PrintScreen') {
                        navigator.clipboard.writeText(''); 
                        alert('‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠! ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ');
                        setWarnings(w => w + 1);
                    }
                };

                document.addEventListener('contextmenu', handleContextMenu);
                document.addEventListener('keydown', handleKeyDown);
                document.addEventListener('keyup', handleKeyUp);

                // Prevent accidentally leaving
                const handleBeforeUnload = (e) => {
                    e.preventDefault();
                    e.returnValue = ''; // Required for Chrome
                };
                window.addEventListener('beforeunload', handleBeforeUnload);

                return () => {
                    document.removeEventListener('contextmenu', handleContextMenu);
                    document.removeEventListener('keydown', handleKeyDown);
                    document.removeEventListener('keyup', handleKeyUp);
                    window.removeEventListener('beforeunload', handleBeforeUnload);
                };
            }, [view]);

            // 3.4 Timer & Blur
            useEffect(() => {
                let interval;
                if(view === 'quiz' && timer > 0 && !isSubmitting) {
                    interval = setInterval(() => {
                        setTimer(t => { if(t<=1) { clearInterval(interval); handleSubmitExam(answers, warnings, true); return 0; } return t-1; });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [view, timer, isSubmitting, answers, warnings]);

            useEffect(() => {
                if(view !== 'quiz' || isSubmitting) return;
                const handleBlur = () => {
                    setWarnings(w => {
                        const nw = w + 1;
                        if(nw >= 3) { alert("‚ö†Ô∏è ‡∏ú‡∏¥‡∏î‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö (‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ"); handleSubmitExam(answers, nw, true); }
                        else alert(`üö® ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${nw}/3: ‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏≠‡∏ö!`);
                        return nw;
                    });
                };
                window.addEventListener('blur', handleBlur);
                return () => window.removeEventListener('blur', handleBlur);
            }, [view, isSubmitting, answers]);

            // 3.5 Actions
            const handleStartExam = () => {
                if(questions.length === 0) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‚ùå");
                let examQs = [...questions];
                if(settings.shuffleQuestions) examQs = shuffle(examQs);
                examQs = examQs.slice(0, settings.randomCount);
                if(settings.shuffleOptions) {
                    examQs = examQs.map(q => {
                        const opts = q.options.map((opt, i) => ({ text: opt, isCorrect: i === q.correct }));
                        const shuffled = shuffle(opts);
                        return { ...q, options: shuffled.map(o => o.text), correct: shuffled.findIndex(o => o.isCorrect) };
                    });
                }
                setActiveQs(examQs); setAnswers(Array(examQs.length).fill(null)); setTimer(settings.totalTime * 60); setWarnings(0); setQIndex(0); setView('quiz');
            };

            const handleSubmitExam = async (finalAns, finalWarn, force=false) => {
                if(!force && !window.confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö?")) return;
                setIsSubmitting(true);
                try {
                    const score = finalAns.reduce((acc, a) => acc + (a && a.correct ? 1 : 0), 0);
                    await db.collection(COL_R).add({
                        studentId: student.id || "N/A", firstName: student.name,
                        score, total: activeQs.length, passed: activeQs.length>0 ? (score/activeQs.length)>=0.6 : false,
                        warnings: finalWarn, timestamp: new Date()
                    });
                    localStorage.removeItem(STORAGE_KEY); // Clear session after submit
                    setView('result');
                } catch(e) { alert("Error: " + e.message); } 
                finally { setIsSubmitting(false); }
            };

            const handleTeacherLogin = async (email, pwd) => {
                try {
                    await auth.signInWithEmailAndPassword(email, pwd);
                    setView('teacher'); setModal(null);
                } catch(e) { alert("Login Failed: " + e.message); }
            };

            const handleImportCSV = (file) => {
                setImporting(true);
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const rows = e.target.result.split(/\r\n|\n|\r/).filter(r => r.trim());
                        const batch = db.batch();
                        let count = 0;
                        for(let i=1; i<rows.length; i++) {
                            const cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
                            if(cols.length >= 6) {
                                const corr = (cols[5].match(/\d+/) || [-1])[0] - 1;
                                if(corr >= 0 && corr < 4) {
                                    const id = String(Date.now() + i);
                                    batch.set(db.collection(COL_Q).doc(id), { question: cols[0], options: [cols[1],cols[2],cols[3],cols[4]], correct: Number(corr), timestamp: firebase.firestore.FieldValue.serverTimestamp(), id });
                                    count++;
                                }
                            }
                        }
                        if(count > 0) batch.commit().then(() => alert(`‚úÖ Imported ${count} questions`));
                    } catch(err) { alert("CSV Error"); }
                    setImporting(false);
                };
                reader.readAsText(file);
            };

            // --- Renders ---
            if(loading) return <div className="flex h-screen items-center justify-center"><Icon name="Loader" className="animate-spin mr-2"/> Loading...</div>;

            if(view === 'landing') return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-4 animate-fade-in">
                    <StatusBar currentStep="landing" />
                    <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-4xl text-center">
                        <div className="inline-block p-4 bg-blue-100 rounded-full mb-6"><Icon name="BookOpen" size={48} className="text-blue-600"/></div>
                        <h1 className="text-4xl font-extrabold text-gray-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå üéì</h1>
                        <p className="text-gray-500 mb-10">Secure Examination System</p>
                        <div className="grid md:grid-cols-2 gap-6">
                            <button onClick={() => setModal({ type: 'student-login' })} className="p-8 border-2 border-transparent hover:border-blue-500 bg-gray-50 rounded-2xl flex flex-col items-center hover:shadow-lg transition group">
                                <div className="bg-white p-4 rounded-full shadow-sm mb-4 group-hover:scale-110 transition"><Icon name="User" size={32} className="text-blue-600"/></div>
                                <h3 className="text-xl font-bold text-gray-700">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Student)</h3>
                            </button>
                            <button onClick={() => setModal({ type: 'teacher-login' })} className="p-8 border-2 border-transparent hover:border-indigo-500 bg-gray-50 rounded-2xl flex flex-col items-center hover:shadow-lg transition group">
                                <div className="bg-white p-4 rounded-full shadow-sm mb-4 group-hover:scale-110 transition"><Icon name="Lock" size={32} className="text-indigo-600"/></div>
                                <h3 className="text-xl font-bold text-gray-700">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô (Teacher)</h3>
                            </button>
                        </div>
                    </div>
                    <Modal isOpen={modal?.type === 'student-login'} onClose={()=>setModal(null)} title="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö üîê" size="sm">
                        <div className="space-y-4">
                            <input className="w-full p-3 border rounded-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Student ID)" value={student.id} onChange={e=>setStudent({...student, id:e.target.value})}/>
                            <input className="w-full p-3 border rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (Name)" value={student.name} onChange={e=>setStudent({...student, name:e.target.value})}/>
                            <button onClick={()=>{ if(student.id && student.name) setView('instruction'); else alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); }} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö üöÄ</button>
                        </div>
                    </Modal>
                    <Modal isOpen={modal?.type === 'teacher-login'} onClose={()=>setModal(null)} title="Admin Login" size="sm">
                        <div className="space-y-4">
                            <input id="t_email" className="w-full p-3 border rounded-lg" placeholder="Email"/>
                            <input id="t_pwd" type="password" className="w-full p-3 border rounded-lg" placeholder="Password"/>
                            <button onClick={()=>handleTeacherLogin(document.getElementById('t_email').value, document.getElementById('t_pwd').value)} className="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700">Login ‚úÖ</button>
                        </div>
                    </Modal>
                </div>
            );

            if(view === 'instruction') return (
                <div className="flex flex-col min-h-screen p-4 animate-fade-in">
                    <StatusBar currentStep="instruction" />
                    <div className="max-w-3xl mx-auto w-full bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div className="text-center pt-8 pb-4 px-6"><h2 className="text-2xl font-bold text-gray-800">‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á üìù</h2><div className="mt-2 text-indigo-600 font-medium bg-indigo-50 inline-block px-4 py-1 rounded-full">‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö: {student.name} ({student.id})</div></div>
                        <div className="px-8 py-4"><div className="bg-white rounded-xl border-2 border-gray-100 p-6 text-gray-700 prose prose-sm max-w-none" dangerouslySetInnerHTML={{__html: settings.instructions}}></div></div>
                        <div className="flex justify-center gap-4 bg-blue-50 mx-8 mb-6 p-4 rounded-lg text-sm text-blue-800 font-bold">
                            <span><Icon name="Clock" size={16}/> {settings.totalTime} ‡∏ô‡∏≤‡∏ó‡∏µ</span>
                            <span><Icon name="List" size={16}/> {settings.randomCount} ‡∏Ç‡πâ‡∏≠</span>
                        </div>
                        <div className="flex gap-4 px-8 pb-8"><button onClick={handleStartExam} className="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‚úçÔ∏è</button><button onClick={()=>{setView('landing'); setModal(null);}} className="px-6 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‚ùå</button></div>
                    </div>
                </div>
            );

            if(view === 'quiz') {
                const q = activeQs[qIndex];
                return (
                    <div className="flex flex-col min-h-screen p-4 animate-fade-in no-select relative">
                        <WatermarkOverlay text={`${student.id} - ${student.name}`} />
                        <StatusBar currentStep="quiz" totalQuestions={activeQs.length} answers={answers} />
                        <div className="max-w-4xl mx-auto w-full z-10">
                            <div className="bg-white/90 backdrop-blur rounded-2xl shadow-sm p-4 mb-6 flex justify-between items-center sticky top-2 border border-gray-100">
                                <div className="flex items-center gap-3"><div className="bg-indigo-100 p-2 rounded-full text-indigo-600 font-bold text-sm">‡∏Ç‡πâ‡∏≠ {qIndex + 1}</div></div>
                                <div className={`flex items-center gap-2 px-4 py-2 rounded-full font-mono font-bold text-lg ${timer < 300 ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-gray-100 text-gray-700'}`}><Icon name="Clock" size={20}/> {formatTime(timer)}</div>
                                <button onClick={()=>handleSubmitExam(answers, warnings)} disabled={isSubmitting} className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-sm">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö üì§</button>
                            </div>
                            <div className="bg-white/95 backdrop-blur rounded-2xl shadow-lg p-8 mb-6"><div className="text-xl text-gray-800 leading-relaxed font-medium" dangerouslySetInnerHTML={{__html: q.question}}></div></div>
                            <div className="grid gap-3">{q.options.map((opt, idx) => { const isSelected = answers[qIndex]?.opt === idx; return (<button key={idx} onClick={() => { const na = [...answers]; na[qIndex] = { qId: q.id, opt: idx, correct: idx === q.correct }; setAnswers(na); }} className={`p-4 rounded-xl border-2 text-left transition flex items-center gap-4 bg-white/90 hover:bg-white ${isSelected ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-gray-200 hover:border-blue-300'}`}><div className={`w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold text-sm ${isSelected ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500'}`}>{['A','B','C','D'][idx]}</div><div className="text-lg text-gray-700">{opt}</div></button>); })}</div>
                            <div className="flex justify-between mt-8 pb-10"><button disabled={qIndex === 0} onClick={() => setQIndex(i => i - 1)} className="px-6 py-3 bg-white border border-gray-300 rounded-xl font-bold text-gray-600 hover:bg-gray-50 disabled:opacity-50">‚¨ÖÔ∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button><button disabled={qIndex === activeQs.length - 1} onClick={() => setQIndex(i => i + 1)} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 disabled:opacity-50">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button></div>
                        </div>
                    </div>
                );
            }

            if(view === 'result') return (
                <div className="flex flex-col min-h-screen p-4 animate-fade-in"><StatusBar currentStep="result" /><div className="flex-grow flex items-center justify-center"><div className="bg-white p-12 rounded-3xl shadow-2xl text-center max-w-lg w-full"><div className="inline-block p-6 bg-green-100 rounded-full mb-6 animate-bounce"><Icon name="Award" size={64} className="text-green-600"/></div><h2 className="text-3xl font-bold text-gray-800 mb-2">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! üéâ</h2><p className="text-gray-500 mb-8">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p><button onClick={()=>{setView('landing'); setModal(null); localStorage.removeItem(STORAGE_KEY);}} className="w-full bg-gray-900 text-white py-4 rounded-xl font-bold hover:bg-black transition">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å üè†</button></div></div></div>
            );

            if(view === 'teacher') return (
                <div className="max-w-6xl mx-auto my-6 bg-white min-h-[90vh] rounded-2xl shadow-xl flex flex-col animate-fade-in overflow-hidden">
                    <div className="bg-slate-800 text-white p-6 flex justify-between items-center sticky top-0 z-20">
                        <div className="flex items-center gap-3"><div className="bg-white/10 p-2 rounded-lg"><Icon name="Settings" size={24}/></div><div><h2 className="font-bold text-xl">Admin Panel</h2></div></div>
                        <div className="flex gap-3">
                            <button onClick={()=>setRefreshKey(k=>k+1)} className="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg font-bold text-sm flex gap-2 items-center"><Icon name="RefreshCw" size={16}/> Reload</button>
                            <button onClick={()=>setView('landing')} className="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-bold text-sm">Exit üö™</button>
                        </div>
                    </div>
                    <div className="p-6 overflow-y-auto flex-grow bg-slate-50">
                        <div className="flex border-b border-gray-200 mb-6 gap-4">
                            {['questions', 'results', 'settings'].map(t => <button key={t} onClick={()=>setActiveTab(t)} className={`pb-2 font-bold capitalize transition ${activeTab===t?'text-indigo-600 border-b-2 border-indigo-600':'text-gray-500'}`}>{t}</button>)}
                        </div>
                        {activeTab === 'questions' && (
                            <div>
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-xl">Questions ({questions.length})</h3><div className="flex gap-2"><button onClick={()=>document.getElementById('csvInput').click()} className="bg-white border border-blue-600 text-blue-600 px-3 py-2 rounded-lg font-bold text-sm flex gap-2">{importing ? <Icon name="Loader" className="animate-spin"/> : <Icon name="Upload"/>} Import CSV</button><input id="csvInput" type="file" accept=".csv" className="hidden" onChange={e=>handleImportCSV(e.target.files[0])}/><button onClick={()=>setModal({type:'q-form',data:{}})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex gap-2"><Icon name="PlusCircle"/> Add</button></div></div>
                                <div className="space-y-4">{questions.map((q, i) => (<div key={q.id} className="bg-white p-5 rounded-xl border shadow-sm flex gap-4"><div className="bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center font-bold text-gray-500 shrink-0">{i+1}</div><div className="flex-grow"><div className="font-medium text-lg mb-2" dangerouslySetInnerHTML={{__html: q.question}}></div><div className="grid grid-cols-2 gap-2 text-sm">{q.options.map((o, idx) => (<div key={idx} className={`flex items-center gap-2 ${idx===q.correct ? 'text-green-600 font-bold':''}`}>{idx===q.correct && <Icon name="Check" size={14}/>} {o}</div>))}</div></div><div className="flex flex-col gap-2"><button onClick={()=>setModal({type:'q-form', data:q})} className="text-gray-400 hover:text-indigo-600"><Icon name="Edit" size={18}/></button><button onClick={()=>{if(confirm('Delete?')) db.collection(COL_Q).doc(q.id).delete()}} className="text-gray-400 hover:text-red-600"><Icon name="Trash2" size={18}/></button></div></div>))}</div>
                            </div>
                        )}
                        {activeTab === 'results' && (
                            <div>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Total</p><p className="text-3xl font-bold text-indigo-600">{results.length}</p></div>
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Pass</p><p className="text-3xl font-bold text-emerald-600">{results.filter(r=>r.passed).length}</p></div>
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Fail</p><p className="text-3xl font-bold text-red-500">{results.filter(r=>!r.passed).length}</p></div>
                                </div>
                                <input placeholder="Search Name/ID..." className="w-full p-3 border rounded-xl mb-4" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/>
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left min-w-[700px]">
                                            <thead className="bg-gray-50 border-b"><tr><th className="p-4">Time</th><th className="p-4">ID</th><th className="p-4">Name</th><th className="p-4 text-center">Score</th><th className="p-4 text-center">Warning</th></tr></thead>
                                            <tbody className="divide-y">{results.filter(r=>(r.firstName+r.studentId).toLowerCase().includes(searchTerm.toLowerCase())).map((r,i)=>(<tr key={i} className="hover:bg-gray-50"><td className="p-4 text-sm text-gray-500">{r.timestamp?.seconds ? new Date(r.timestamp.seconds*1000).toLocaleString('th-TH') : '-'}</td><td className="p-4 font-mono text-indigo-600 font-bold">{r.studentId}</td><td className="p-4">{r.firstName} {r.lastName}</td><td className="p-4 text-center font-bold">{r.score}/{r.total}</td><td className="p-4 text-center">{r.warnings>0?<span className="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold">{r.warnings}</span>:'-'}</td></tr>))}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeTab === 'settings' && (
                            <div className="grid gap-6 md:grid-cols-2">
                                <div className="bg-white p-6 rounded-xl border shadow-sm space-y-4">
                                    <h3 className="font-bold flex items-center gap-2"><Icon name="Clock"/> General</h3>
                                    <div className="flex justify-between items-center"><span>Time (Minutes)</span><input type="number" className="border p-2 rounded w-20 text-center" value={settings.totalTime} onChange={e=>setSettings({...settings, totalTime:Number(e.target.value)})}/></div>
                                    <div className="flex justify-between items-center"><span>Random Questions</span><input type="number" className="border p-2 rounded w-20 text-center" value={settings.randomCount} onChange={e=>setSettings({...settings, randomCount:Number(e.target.value)})}/></div>
                                </div>
                                <div className="bg-white p-6 rounded-xl border shadow-sm space-y-4">
                                    <h3 className="font-bold flex items-center gap-2"><Icon name="Shuffle"/> Shuffle</h3>
                                    <div className="flex justify-between items-center"><span>Shuffle Questions</span><input type="checkbox" className="w-5 h-5" checked={settings.shuffleQuestions} onChange={e=>setSettings({...settings, shuffleQuestions:e.target.checked})}/></div>
                                    <div className="flex justify-between items-center"><span>Shuffle Options</span><input type="checkbox" className="w-5 h-5" checked={settings.shuffleOptions} onChange={e=>setSettings({...settings, shuffleOptions:e.target.checked})}/></div>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="font-bold block mb-2">Instructions</label>
                                    <RichTextEditor value={settings.instructions} onChange={v=>setSettings({...settings, instructions:v})}/>
                                    <button onClick={()=>db.collection(COL_S).doc(DOC_S).set(settings).then(()=>alert("Saved!"))} className="mt-4 w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">Save Settings üíæ</button>
                                </div>
                            </div>
                        )}
                    </div>
                    <Modal isOpen={modal?.type === 'q-form'} onClose={()=>setModal(null)} title={modal?.data?.id ? "Edit Question" : "New Question"} size="lg">
                        <QuestionForm 
                            initialData={modal?.data} 
                            onSave={(q)=>{ const ref=q.id?db.collection(COL_Q).doc(q.id):db.collection(COL_Q).doc(String(Date.now())); ref.set({ ...q, timestamp: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true}).then(()=>setModal(null)); }} 
                            onCancel={()=>setModal(null)}
                        />
                    </Modal>
                </div>
            );
            return null;
        };

        const QuestionForm = ({ initialData, onSave, onCancel }) => {
            const [q, setQ] = useState(initialData?.question || '');
            const [opts, setOpts] = useState(initialData?.options || ['','','','']);
            const [correct, setCorrect] = useState(initialData?.correct ?? 0);
            return (<div className="space-y-6"><div><label className="font-bold block mb-2">Question</label><RichTextEditor value={q} onChange={setQ}/></div><div><label className="font-bold block mb-2">Options (Click circle to set correct answer)</label><div className="space-y-3">{opts.map((opt, i) => (<div key={i} className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer ${correct===i?'border-green-500 bg-green-50':''}`} onClick={()=>setCorrect(i)}><div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${correct===i?'bg-green-600 border-green-600 text-white':'bg-white'}`}>{correct===i && <Icon name="Check" size={14}/>}</div><input className="flex-grow bg-transparent outline-none border-b border-transparent focus:border-indigo-400" value={opt} onChange={e=>{const n=[...opts];n[i]=e.target.value;setOpts(n)}} placeholder={`Option ${i+1}`} onClick={e=>e.stopPropagation()}/></div>))}</div></div><div className="pt-4 border-t flex justify-end gap-3"><button onClick={onCancel} className="px-6 py-2 bg-gray-100 rounded-lg font-bold">Cancel</button><button onClick={()=>onSave({ id: initialData?.id, question: q, options: opts, correct })} className="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold">Save</button></div></div>);
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExamApp />);
    </script>
</body>
</html>
