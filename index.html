<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Exam System</title>
    
    <!-- 1. ฟอนต์ Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Sarabun', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- 3. React & Babel (สำหรับรัน JSX ใน Browser) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Lucide Icons (ไอคอน) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 5. Firebase (เวอร์ชัน Compat สำหรับ HTML ไฟล์เดียว) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f9fafb; }
        /* Scrollbar แต่งสวย */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        /* Animation */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- ส่วนของ React Code -->
    <script type="text/babel">
        // ดึงตัวแปรจาก React Global
        const { useState, useEffect, useRef } = React;

        // --- 1. ตั้งค่า Firebase (เปลี่ยน API Key เป็นของคุณ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA7VSQL0LNIBEsMqKeJikS-xvKv4OBA3hQ",
            authDomain: "online-exam-e0282.firebaseapp.com",
            projectId: "online-exam-e0282",
            storageBucket: "online-exam-e0282.firebasestorage.app",
            messagingSenderId: "743597814646",
            appId: "1:743597814646:web:7daff8ce1f01623df8c057",
            measurementId: "G-75674HXF78"
        };

        // Initialize Firebase (Check if already initialized)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Path ของข้อมูล (ต้องตรงกับ Rules)
        const appId = 'online-exam-default'; 
        const QUESTIONS_COLLECTION = `artifacts/${appId}/public/data/questions`;
        const RESULTS_COLLECTION = `artifacts/${appId}/public/data/results`;
        const SETTINGS_COLLECTION = `artifacts/${appId}/public/data/settings`; 
        const SETTINGS_DOC_ID = 'config';

        // --- 2. Icon Component (Wrapper สำหรับ Lucide) ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const spanRef = useRef(null);
            useEffect(() => {
                if (spanRef.current && lucide && lucide.icons[name]) {
                    const svg = lucide.icons[name].toSvg({ class: className, width: size, height: size });
                    spanRef.current.innerHTML = svg;
                }
            }, [name, size, className]);
            return <span ref={spanRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        // สร้าง Components ไอคอนย่อยๆ เพื่อเรียกใช้ง่ายๆ
        const Clock = (p) => <Icon name="Clock" {...p} />;
        const CheckCircle = (p) => <Icon name="CheckCircle" {...p} />;
        const XCircle = (p) => <Icon name="XCircle" {...p} />;
        const ChevronRight = (p) => <Icon name="ChevronRight" {...p} />;
        const RefreshCw = (p) => <Icon name="RefreshCw" {...p} />;
        const Award = (p) => <Icon name="Award" {...p} />;
        const User = (p) => <Icon name="User" {...p} />;
        const BookOpen = (p) => <Icon name="BookOpen" {...p} />;
        const Users = (p) => <Icon name="Users" {...p} />;
        const Lock = (p) => <Icon name="Lock" {...p} />;
        const Edit = (p) => <Icon name="Edit" {...p} />;
        const Save = (p) => <Icon name="Save" {...p} />;
        const Trash2 = (p) => <Icon name="Trash2" {...p} />;
        const LogOut = (p) => <Icon name="LogOut" {...p} />;
        const FileText = (p) => <Icon name="FileText" {...p} />;
        const Settings = (p) => <Icon name="Settings" {...p} />;
        const X = (p) => <Icon name="X" {...p} />;
        const PlusCircle = (p) => <Icon name="PlusCircle" {...p} />;
        const AlertTriangle = (p) => <Icon name="AlertTriangle" {...p} />;
        const Download = (p) => <Icon name="Download" {...p} />;
        const Info = (p) => <Icon name="Info" {...p} />;
        const Bold = (p) => <Icon name="Bold" {...p} />;
        const Italic = (p) => <Icon name="Italic" {...p} />;
        const Underline = (p) => <Icon name="Underline" {...p} />;
        const ImageIcon = (p) => <Icon name="Image" {...p} />;
        const Table = (p) => <Icon name="Table" {...p} />;
        const Type = (p) => <Icon name="Type" {...p} />;
        const Upload = (p) => <Icon name="Upload" {...p} />;
        const FileSpreadsheet = (p) => <Icon name="FileSpreadsheet" {...p} />;
        const Loader = (p) => <Icon name="Loader" {...p} />;
        const ShieldAlert = (p) => <Icon name="ShieldAlert" {...p} />;
        const BellRing = (p) => <Icon name="BellRing" {...p} />;

        // --- 3. Utility Functions ---
        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            return `${m}:${s.toString().padStart(2, '0')}`;
        };

        // --- 4. Sub-Components ---
        const RichTextEditor = ({ value, onChange, placeholder }) => {
            const textareaRef = useRef(null);
            const insertTag = (tagOpen, tagClose = "") => {
                const textarea = textareaRef.current;
                if (!textarea) return;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                const newText = text.substring(0, start) + tagOpen + text.substring(start, end) + tagClose + text.substring(end);
                onChange(newText);
                setTimeout(() => textarea.focus(), 0);
            };
            return (
                <div className="border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-indigo-500 transition">
                    <div className="flex flex-wrap gap-1 bg-gray-50 p-2 border-b border-gray-200">
                        <button type="button" onClick={() => insertTag('<b>', '</b>')} className="p-1.5 hover:bg-gray-200 rounded" title="ตัวหนา"><Bold size={16}/></button>
                        <button type="button" onClick={() => insertTag('<i>', '</i>')} className="p-1.5 hover:bg-gray-200 rounded" title="ตัวเอียง"><Italic size={16}/></button>
                        <button type="button" onClick={() => insertTag('<u>', '</u>')} className="p-1.5 hover:bg-gray-200 rounded" title="ขีดเส้นใต้"><Underline size={16}/></button>
                        <div className="w-px h-6 bg-gray-300 mx-1 self-center"></div>
                        <button type="button" onClick={() => insertTag('<img src=\'', '\' class=\'max-w-full h-auto my-2\' />')} className="p-1.5 hover:bg-gray-200 rounded" title="แทรกรูปภาพ HTML"><ImageIcon size={16}/></button>
                    </div>
                    <textarea ref={textareaRef} className="w-full p-3 outline-none min-h-[120px] font-mono text-sm" value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder} />
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
            if (!isOpen) return null;
            const sizeClasses = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-2xl', xl: 'max-w-4xl' };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className={`relative bg-white rounded-2xl shadow-2xl w-full ${sizeClasses[size]} flex flex-col max-h-[90vh] overflow-hidden transform transition-all animate-scale-up`}>
                        <div className="flex justify-between items-center p-4 border-b bg-gray-50">
                            <h3 className="font-bold text-lg text-gray-700">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 hover:bg-gray-200 p-1 rounded-full"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">{children}</div>
                    </div>
                </div>
            );
        };

        const StudentLoginForm = ({ studentInfo, setStudentInfo, onLogin }) => (
            <div className="space-y-4">
                <div><label className="block text-sm font-bold text-gray-700 mb-1">รหัสนักเรียน</label><input className="w-full p-3 border rounded-lg" placeholder="เช่น 64001" value={studentInfo.id} onChange={e => setStudentInfo({...studentInfo, id: e.target.value})} /></div>
                <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm font-bold text-gray-700 mb-1">ชื่อจริง</label><input className="w-full p-3 border rounded-lg" placeholder="ชื่อจริง" value={studentInfo.firstName} onChange={e => setStudentInfo({...studentInfo, firstName: e.target.value})} /></div>
                    <div><label className="block text-sm font-bold text-gray-700 mb-1">นามสกุล</label><input className="w-full p-3 border rounded-lg" placeholder="นามสกุล" value={studentInfo.lastName} onChange={e => setStudentInfo({...studentInfo, lastName: e.target.value})} /></div>
                </div>
                <button onClick={onLogin} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold mt-2 hover:bg-blue-700">เข้าสู่ระบบ</button>
            </div>
        );

        const TeacherLoginForm = ({ password, setPassword, onLogin }) => (
            <div className="space-y-4">
                <div><label className="block text-sm font-bold text-gray-700 mb-1">รหัสผ่าน</label><input type="password" className="w-full p-3 border rounded-lg" placeholder="Hint: 1234" value={password} onChange={e => setPassword(e.target.value)} /></div>
                <button onClick={onLogin} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold mt-2 hover:bg-indigo-700">ยืนยัน</button>
            </div>
        );

        // --- 5. Main Component ---
        const ExamSystem = () => {
            const [currentView, setCurrentView] = useState('landing');
            const [activeModal, setActiveModal] = useState(null); 
            const [modalData, setModalData] = useState(null); 
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [user, setUser] = useState(null);

            // Data
            const [questionBank, setQuestionBank] = useState([]);
            const [activeQuestions, setActiveQuestions] = useState([]);
            const [examResults, setExamResults] = useState([]);
            const [examSettings, setExamSettings] = useState({ 
                randomCount: 5, totalTime: 60,
                instructions: `<div class="space-y-4 text-gray-700"><h4 class="font-bold text-lg text-indigo-700">ข้อปฏิบัติในการสอบ</h4><ul><li>ข้อสอบเป็นแบบปรนัย 4 ตัวเลือก</li><li>ห้ามสลับหน้าจอระหว่างการสอบ (ระบบมี Anti-Cheat)</li></ul></div>` 
            });
            
            // Student
            const [studentInfo, setStudentInfo] = useState({ firstName: '', lastName: '', id: '' });
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(0);
            const [userAnswers, setUserAnswers] = useState([]); 
            const [teacherPassword, setTeacherPassword] = useState('');
            const [finalWarnings, setFinalWarnings] = useState(0);
            const [isSubmitting, setIsSubmitting] = useState(false);

            // Setup Auth & Listeners (Compat V8 Style)
            useEffect(() => {
                auth.signInAnonymously().catch(err => console.error("Auth failed", err));
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setIsAuthReady(true);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                // Listen to Questions
                const unsubQ = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('questions').orderBy('timestamp', 'asc')
                    .onSnapshot(snap => setQuestionBank(snap.docs.map(doc => ({id: doc.id, ...doc.data()}))));
                
                // Listen to Results
                const unsubR = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('results').orderBy('timestamp', 'desc')
                    .onSnapshot(snap => setExamResults(snap.docs.map(doc => ({id: doc.id, ...doc.data()}))));

                // Fetch Settings
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc(SETTINGS_DOC_ID).get()
                    .then(doc => { if(doc.exists) setExamSettings(prev => ({...prev, ...doc.data()})); });

                return () => { unsubQ(); unsubR(); };
            }, [user]);

            // Timer & Anti-Cheat
            useEffect(() => {
                let timer;
                if (currentView === 'quiz' && timeLeft > 0 && !isSubmitting) {
                    timer = setTimeout(() => setTimeLeft(p => p - 1), 1000);
                } else if (timeLeft === 0 && currentView === 'quiz' && !isSubmitting) {
                    forceSubmit();
                }
                return () => clearTimeout(timer);
            }, [timeLeft, currentView, isSubmitting]);

            // Handlers
            const startExam = () => {
                if(questionBank.length === 0) return alert("ไม่มีข้อสอบ");
                const shuffled = shuffleArray(questionBank).slice(0, examSettings.randomCount);
                setActiveQuestions(shuffled);
                setUserAnswers(Array(shuffled.length).fill(undefined));
                setTimeLeft((examSettings.totalTime || 60) * 60);
                setFinalWarnings(0);
                setScore(0);
                setCurrentQuestionIndex(0);
                setCurrentView('quiz');
            };

            const forceSubmit = () => {
                setIsSubmitting(true);
                // Calculate Score
                const finalScore = userAnswers.reduce((acc, ans) => acc + (ans?.isCorrect ? 1 : 0), 0);
                saveResult(finalScore, finalWarnings);
            };

            const handleAnswer = (optionIdx, warningCount) => {
                setFinalWarnings(warningCount);
                const currentQ = activeQuestions[currentQuestionIndex];
                const isCorrect = optionIdx === currentQ.correct;
                
                const newAns = [...userAnswers];
                newAns[currentQuestionIndex] = { questionId: currentQ.id, selectedOption: optionIdx, isCorrect };
                setUserAnswers(newAns);

                setTimeout(() => {
                    if (currentQuestionIndex < activeQuestions.length - 1) {
                        setCurrentQuestionIndex(p => p + 1);
                    } else {
                        const finalScore = newAns.reduce((acc, ans) => acc + (ans?.isCorrect ? 1 : 0), 0);
                        saveResult(finalScore, warningCount);
                    }
                }, 300);
            };

            const saveResult = (finalScore, warnings) => {
                setIsSubmitting(true);
                setScore(finalScore);
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('results').add({
                    studentId: studentInfo.id,
                    firstName: studentInfo.firstName,
                    lastName: studentInfo.lastName,
                    score: finalScore,
                    total: activeQuestions.length,
                    passed: (finalScore / activeQuestions.length) >= 0.6,
                    warnings: warnings,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => setCurrentView('result')).finally(() => setIsSubmitting(false));
            };

            // CRUD Handlers for Teacher
            const saveQuestion = (qData) => {
                const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('questions');
                const data = { 
                    question: qData.question, options: qData.options, correct: qData.correct, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                };
                
                if (qData.id) {
                    // Update: Firestore ID is usually string, but if we used numeric IDs before, we need to be careful.
                    // For Simplicity in this standalone, we assume qData.id is the Doc ID if it exists in DB.
                    // However, our previous logic generated numeric IDs. Let's try to find correct doc.
                    // Since this is a new clean standalone, let's use Firestore Auto-ID or the ID we pulled.
                    colRef.doc(String(qData.id)).set(data, { merge: true }).then(() => setActiveModal(null));
                } else {
                    // Create New
                    const newId = String(Date.now()); // Simple unique ID
                    colRef.doc(newId).set({ ...data, id: newId }).then(() => setActiveModal(null));
                }
            };

            const deleteQuestion = () => {
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('questions').doc(String(modalData)).delete()
                .then(() => setActiveModal(null));
            };

            const saveSettings = () => {
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc(SETTINGS_DOC_ID).set(examSettings)
                .then(() => alert("บันทึกสำเร็จ"));
            };

            // --- Render Views ---
            
            // 1. Landing
            if (currentView === 'landing') return (
                <div className="flex flex-col items-center justify-center min-h-[80vh] w-full p-4 animate-fade-in">
                    <div className="text-center mb-10">
                        <div className="inline-block p-4 rounded-full bg-blue-50 mb-4 shadow-sm"><BookOpen size={64} className="text-blue-600" /></div>
                        <h1 className="text-4xl font-extrabold text-gray-800 mb-2">ระบบสอบออนไลน์</h1>
                        <p className="text-xl text-gray-500">Online Exam System</p>
                    </div>
                    {!isAuthReady ? <div className="text-gray-500"><Loader className="animate-spin" /> เชื่อมต่อเซิร์ฟเวอร์...</div> : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                            <button onClick={() => setActiveModal('student-login')} className="flex flex-col items-center p-8 bg-white rounded-2xl shadow-md hover:shadow-xl transition group">
                                <div className="bg-blue-100 p-4 rounded-full mb-4 group-hover:bg-blue-600 group-hover:text-white transition"><User size={40} /></div>
                                <h2 className="text-xl font-bold text-gray-700">สำหรับนักเรียน</h2>
                            </button>
                            <button onClick={() => setActiveModal('teacher-login')} className="flex flex-col items-center p-8 bg-white rounded-2xl shadow-md hover:shadow-xl transition group">
                                <div className="bg-indigo-100 p-4 rounded-full mb-4 group-hover:bg-indigo-600 group-hover:text-white transition"><Users size={40} /></div>
                                <h2 className="text-xl font-bold text-gray-700">สำหรับอาจารย์</h2>
                            </button>
                        </div>
                    )}
                    {/* Modals */}
                    <Modal isOpen={activeModal === 'student-login'} onClose={() => setActiveModal(null)} title="ลงชื่อเข้าสอบ">
                        <StudentLoginForm studentInfo={studentInfo} setStudentInfo={setStudentInfo} onLogin={() => {
                            if(studentInfo.firstName && studentInfo.id) { setActiveModal(null); setCurrentView('instruction'); }
                            else alert("กรอกข้อมูลให้ครบ");
                        }} />
                    </Modal>
                    <Modal isOpen={activeModal === 'teacher-login'} onClose={() => setActiveModal(null)} title="อาจารย์">
                        <TeacherLoginForm password={teacherPassword} setPassword={setTeacherPassword} onLogin={() => {
                            if(teacherPassword === '1234') { setActiveModal(null); setCurrentView('teacher-dashboard'); }
                            else alert("รหัสผิด (ลอง 1234)");
                        }} />
                    </Modal>
                </div>
            );

            // 2. Instruction
            if (currentView === 'instruction') return (
                <div className="max-w-2xl mx-auto my-8 bg-white rounded-2xl shadow-xl overflow-hidden animate-fade-in">
                    <div className="bg-blue-600 p-6 text-white text-center"><h2 className="text-2xl font-bold">คำชี้แจง</h2></div>
                    <div className="p-8 space-y-6">
                        <div className="flex gap-4 p-4 bg-blue-50 rounded-xl items-center"><User className="text-blue-600"/> <div><h3 className="font-bold">{studentInfo.firstName} {studentInfo.lastName}</h3><p className="text-sm">{studentInfo.id}</p></div></div>
                        <div className="prose prose-sm max-w-none text-gray-600" dangerouslySetInnerHTML={{ __html: examSettings.instructions }} />
                        <div className="flex items-center gap-2 text-indigo-600 font-bold"><Clock /> เวลาสอบ: {examSettings.totalTime || 60} นาที</div>
                        <div className="p-3 bg-red-50 text-red-700 text-sm rounded border border-red-200 flex gap-2"><ShieldAlert /> ห้ามสลับหน้าจอเกิน 3 ครั้ง ระบบจะยุติการสอบทันที</div>
                        <div className="flex gap-4 pt-4">
                            <button onClick={startExam} className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">เริ่มทำข้อสอบ</button>
                            <button onClick={() => setCurrentView('landing')} className="px-6 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">ยกเลิก</button>
                        </div>
                    </div>
                </div>
            );

            // 3. Quiz
            if (currentView === 'quiz') {
                const currentQ = activeQuestions[currentQuestionIndex];
                // Anti-Cheat Hook inside Render (Simple version)
                useEffect(() => {
                    const handleBlur = () => {
                        if(isSubmitting) return;
                        setFinalWarnings(p => {
                            const n = p + 1;
                            if (n >= 3) { alert("ทำผิดกฎเกินกำหนด! ยุติการสอบ"); forceSubmit(); }
                            else alert(`เตือนครั้งที่ ${n}/3: ห้ามออกจากหน้าจอ!`);
                            return n;
                        });
                    };
                    window.addEventListener('blur', handleBlur);
                    return () => window.removeEventListener('blur', handleBlur);
                }, [isSubmitting]);

                return (
                    <div className="max-w-4xl mx-auto p-4 pt-8 animate-fade-in">
                        <div className="flex justify-between items-center mb-6 bg-white p-4 rounded-2xl shadow-sm">
                            <div className="flex gap-3 items-center"><div className="bg-blue-100 p-2 rounded-full"><User size={20} className="text-blue-600"/></div><span className="font-bold">{studentInfo.firstName}</span></div>
                            <div className={`flex gap-2 px-4 py-2 rounded-full font-mono font-bold ${timeLeft < 300 ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-gray-100'}`}><Clock size={20}/> {formatTime(timeLeft)}</div>
                        </div>
                        <div className="bg-white p-8 rounded-2xl shadow-xl mb-6">
                            <div className="text-sm text-gray-500 font-bold mb-2">ข้อที่ {currentQuestionIndex + 1} / {activeQuestions.length}</div>
                            <div className="text-2xl text-gray-800" dangerouslySetInnerHTML={{ __html: currentQ?.question || 'Loading...' }} />
                        </div>
                        <div className="grid gap-4">
                            {currentQ?.options.map((opt, i) => (
                                <button key={i} onClick={() => handleAnswer(i, finalWarnings)} disabled={isSubmitting} className="p-5 rounded-xl border-2 text-left hover:border-blue-500 hover:bg-blue-50 transition flex justify-between items-center group">
                                    <span>{opt}</span>
                                    {userAnswers[currentQuestionIndex]?.selectedOption === i && <CheckCircle className="text-blue-500"/>}
                                </button>
                            ))}
                        </div>
                        {isSubmitting && <div className="text-center mt-4"><Loader className="animate-spin inline"/> กำลังส่งคำตอบ...</div>}
                    </div>
                );
            }

            // 4. Result
            if (currentView === 'result') return (
                <div className="max-w-lg mx-auto p-4 text-center mt-10 animate-fade-in">
                    <div className="bg-white p-10 rounded-3xl shadow-2xl relative overflow-hidden">
                        <div className={`absolute inset-0 opacity-10 ${(score/activeQuestions.length)>=0.6 ? 'bg-green-500':'bg-red-500'}`}></div>
                        <Award size={64} className="mx-auto mb-4 text-gray-700 relative z-10"/>
                        <h2 className="text-3xl font-bold mb-2 relative z-10">ส่งคำตอบเรียบร้อย</h2>
                        <div className="text-6xl font-black my-6 relative z-10">{score} <span className="text-2xl text-gray-400">/ {activeQuestions.length}</span></div>
                        <button onClick={goHome} className="w-full bg-gray-800 text-white py-3 rounded-xl font-bold relative z-10">กลับหน้าหลัก</button>
                    </div>
                </div>
            );

            // 5. Teacher Dashboard
            if (currentView === 'teacher-dashboard') return (
                <div className="max-w-6xl mx-auto bg-white min-h-[85vh] rounded-2xl shadow-xl flex flex-col mt-4 animate-fade-in">
                    <div className="bg-indigo-700 text-white p-6 flex justify-between items-center">
                        <h2 className="text-2xl font-bold flex gap-2"><BookOpen/> ระบบจัดการข้อสอบ</h2>
                        <button onClick={goHome} className="flex gap-2 items-center bg-indigo-800 px-4 py-2 rounded-lg hover:bg-indigo-900"><LogOut size={18}/> ออก</button>
                    </div>
                    
                    <div className="p-6 overflow-y-auto flex-grow">
                        <div className="flex gap-4 mb-6 border-b pb-2">
                            <button className="font-bold text-indigo-600 border-b-2 border-indigo-600 pb-1">คลังข้อสอบ ({questionBank.length})</button>
                            <button className="font-bold text-gray-500 hover:text-indigo-600" onClick={() => {
                                const newTime = prompt("กำหนดเวลาสอบ (นาที):", examSettings.totalTime);
                                if(newTime) setExamSettings({...examSettings, totalTime: Number(newTime)});
                                saveSettings();
                            }}>ตั้งเวลาสอบ</button>
                            <button className="font-bold text-gray-500 hover:text-indigo-600" onClick={() => {
                                const newInst = prompt("แก้ไขคำชี้แจง (HTML):", examSettings.instructions);
                                if(newInst) setExamSettings({...examSettings, instructions: newInst});
                                saveSettings();
                            }}>แก้ไขคำชี้แจง</button>
                        </div>

                        <div className="space-y-4">
                            <button onClick={() => { setModalData({}); setActiveModal('question-form'); }} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 mb-4 shadow"><PlusCircle size={18}/> เพิ่มข้อสอบใหม่</button>
                            
                            {questionBank.map((q, i) => (
                                <div key={q.id} className="border p-4 rounded-xl flex justify-between items-start hover:shadow-md transition">
                                    <div>
                                        <span className="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded font-bold mr-2">Q{i+1}</span>
                                        <span className="font-medium" dangerouslySetInnerHTML={{__html: q.question}}></span>
                                        <div className="text-sm text-gray-500 mt-2 ml-8 grid grid-cols-2 gap-2">
                                            {q.options.map((o, idx) => <span key={idx} className={idx===q.correct ? 'text-green-600 font-bold' : ''}>{idx+1}. {o}</span>)}
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => { setModalData(q); setActiveModal('question-form'); }} className="text-gray-400 hover:text-indigo-600"><Edit size={18}/></button>
                                        <button onClick={() => { setModalData(q.id); setActiveModal('delete-confirm'); }} className="text-gray-400 hover:text-red-600"><Trash2 size={18}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <Modal isOpen={activeModal === 'question-form'} onClose={() => setActiveModal(null)} title={modalData.id ? "แก้ไข" : "เพิ่ม"} size="lg">
                        <QuestionForm initialData={modalData} onSave={saveQuestion} onCancel={() => setActiveModal(null)} />
                    </Modal>
                    <Modal isOpen={activeModal === 'delete-confirm'} onClose={() => setActiveModal(null)} title="ลบข้อสอบ">
                        <div className="text-center p-4">
                            <p>ยืนยันการลบข้อสอบนี้?</p>
                            <div className="flex gap-4 mt-4 justify-center">
                                <button onClick={deleteQuestion} className="bg-red-600 text-white px-6 py-2 rounded-lg">ลบ</button>
                                <button onClick={() => setActiveModal(null)} className="bg-gray-200 px-6 py-2 rounded-lg">ยกเลิก</button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );

            return <div>Loading...</div>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExamSystem />);
    </script>
</body>
</html>
